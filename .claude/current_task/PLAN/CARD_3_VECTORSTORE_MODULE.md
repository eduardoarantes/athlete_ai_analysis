# CARD 3: Vectorstore Module

**Status:** Pending
**Estimated Time:** 2 hours
**Dependencies:** Card 2 (Embeddings Module)

---

## Objective

Implement a thin wrapper around LangChain's Chroma vectorstore to support multi-collection management and our two-vectorstore design.

**Key Principle:** Delegate all vectorstore operations to LangChain's `Chroma`. We only add collection management logic.

---

## Implementation

### File: `src/cycling_ai/rag/vectorstore.py`

```python
"""
ChromaVectorStore wrapper using LangChain.

This module provides a thin wrapper around LangChain's Chroma vectorstore
to support multi-collection management and our two-vectorstore design.

Examples:
    >>> from pathlib import Path
    >>> from cycling_ai.rag.embeddings import EmbeddingFactory
    >>> from cycling_ai.rag.vectorstore import ChromaVectorStore
    >>> from langchain_core.documents import Document
    >>>
    >>> # Create vectorstore
    >>> embeddings = EmbeddingFactory.create_local()
    >>> vectorstore = ChromaVectorStore(
    ...     persist_directory=Path("./my_vectorstore"),
    ...     embedding_function=embeddings
    ... )
    >>>
    >>> # Add documents
    >>> docs = [Document(page_content="Example text", metadata={"source": "test"})]
    >>> vectorstore.add_documents("my_collection", docs)
    >>>
    >>> # Search
    >>> results = vectorstore.similarity_search("my_collection", "example query", k=3)
"""

from __future__ import annotations

from pathlib import Path
from typing import TYPE_CHECKING, Any

if TYPE_CHECKING:
    from langchain_core.documents import Document
    from langchain_core.embeddings import Embeddings


class ChromaVectorStore:
    """
    Wrapper around LangChain Chroma vectorstore.

    Manages multiple collections in a single Chroma instance.
    Supports our two-vectorstore design (project + user).

    Attributes:
        persist_directory: Directory for Chroma persistence
        embedding_function: LangChain Embeddings instance
    """

    def __init__(
        self,
        persist_directory: Path,
        embedding_function: Embeddings,
    ) -> None:
        """
        Initialize Chroma vectorstore wrapper.

        Args:
            persist_directory: Directory for Chroma persistence (created if needed)
            embedding_function: LangChain Embeddings instance

        Raises:
            OSError: If directory creation fails
        """
        self.persist_directory = persist_directory
        self.persist_directory.mkdir(parents=True, exist_ok=True)
        self.embedding_function = embedding_function

        # Collection cache: {collection_name: Chroma}
        self._collections: dict[str, Any] = {}

    def get_or_create_collection(
        self,
        collection_name: str,
    ) -> Any:  # Returns Chroma, but avoiding import for type checking
        """
        Get or create a Chroma collection.

        Uses LangChain's Chroma class to create/load collections.

        Args:
            collection_name: Name of collection

        Returns:
            LangChain Chroma instance

        Examples:
            >>> collection = vectorstore.get_or_create_collection("domain_knowledge")
        """
        if collection_name in self._collections:
            return self._collections[collection_name]

        # Import here to avoid circular dependency issues
        from langchain_community.vectorstores import Chroma

        # Create new collection using LangChain
        chroma = Chroma(
            collection_name=collection_name,
            embedding_function=self.embedding_function,
            persist_directory=str(self.persist_directory),
        )

        self._collections[collection_name] = chroma
        return chroma

    def add_documents(
        self,
        collection_name: str,
        documents: list[Document],
    ) -> list[str]:
        """
        Add documents to collection.

        Uses LangChain's Chroma.add_documents().

        Args:
            collection_name: Target collection
            documents: LangChain Document objects (page_content + metadata)

        Returns:
            List of document IDs (auto-generated by Chroma)

        Raises:
            ValueError: If documents list is empty

        Examples:
            >>> from langchain_core.documents import Document
            >>> docs = [
            ...     Document(
            ...         page_content="Polarized training is 80% low intensity...",
            ...         metadata={"category": "training_methodology"}
            ...     )
            ... ]
            >>> ids = vectorstore.add_documents("domain_knowledge", docs)
        """
        if not documents:
            raise ValueError("Cannot add empty documents list")

        collection = self.get_or_create_collection(collection_name)
        return collection.add_documents(documents)

    def similarity_search(
        self,
        collection_name: str,
        query: str,
        k: int = 5,
        filter: dict[str, Any] | None = None,
    ) -> list[Document]:
        """
        Search for similar documents.

        Uses LangChain's Chroma.similarity_search().

        Args:
            collection_name: Collection to search
            query: Search query (natural language)
            k: Number of results to return
            filter: Metadata filter (e.g., {"category": "performance"})

        Returns:
            List of LangChain Documents (most similar first)

        Examples:
            >>> results = vectorstore.similarity_search(
            ...     collection_name="domain_knowledge",
            ...     query="polarized training model",
            ...     k=3,
            ...     filter={"category": "training_methodology"}
            ... )
            >>> for doc in results:
            ...     print(doc.page_content)
            ...     print(doc.metadata)
        """
        collection = self.get_or_create_collection(collection_name)
        return collection.similarity_search(
            query=query,
            k=k,
            filter=filter,
        )

    def similarity_search_with_score(
        self,
        collection_name: str,
        query: str,
        k: int = 5,
        filter: dict[str, Any] | None = None,
    ) -> list[tuple[Document, float]]:
        """
        Search with relevance scores.

        Uses LangChain's Chroma.similarity_search_with_score().

        Args:
            collection_name: Collection to search
            query: Search query
            k: Number of results
            filter: Metadata filter

        Returns:
            List of (Document, score) tuples
            Scores are cosine similarity (0-1, higher = more similar)

        Examples:
            >>> results = vectorstore.similarity_search_with_score(
            ...     collection_name="domain_knowledge",
            ...     query="FTP testing protocols",
            ...     k=5
            ... )
            >>> for doc, score in results:
            ...     print(f"Score: {score:.3f}")
            ...     print(f"Content: {doc.page_content[:100]}...")
        """
        collection = self.get_or_create_collection(collection_name)
        return collection.similarity_search_with_score(
            query=query,
            k=k,
            filter=filter,
        )

    def delete_collection(self, collection_name: str) -> None:
        """
        Delete a collection.

        Args:
            collection_name: Collection to delete

        Examples:
            >>> vectorstore.delete_collection("old_collection")
        """
        if collection_name in self._collections:
            collection = self._collections[collection_name]
            collection.delete_collection()
            del self._collections[collection_name]
```

---

## Tests

### File: `tests/rag/test_vectorstore.py`

```python
"""
Tests for ChromaVectorStore wrapper.

Tests cover:
- Collection creation
- Document addition
- Similarity search
- Metadata filtering
- Persistence
"""

from __future__ import annotations

from pathlib import Path

import pytest
from langchain_core.documents import Document

from cycling_ai.rag.embeddings import EmbeddingFactory
from cycling_ai.rag.vectorstore import ChromaVectorStore


class TestChromaVectorStoreInit:
    """Test ChromaVectorStore initialization."""

    def test_init_creates_directory(self, tmp_path: Path) -> None:
        """Test that initialization creates persist directory."""
        persist_dir = tmp_path / "vectorstore"
        assert not persist_dir.exists()

        embeddings = EmbeddingFactory.create_local()
        vectorstore = ChromaVectorStore(
            persist_directory=persist_dir,
            embedding_function=embeddings,
        )

        assert persist_dir.exists()
        assert persist_dir.is_dir()
        assert vectorstore.persist_directory == persist_dir

    def test_init_with_existing_directory(self, tmp_path: Path) -> None:
        """Test initialization with existing directory."""
        persist_dir = tmp_path / "existing"
        persist_dir.mkdir()

        embeddings = EmbeddingFactory.create_local()
        vectorstore = ChromaVectorStore(
            persist_directory=persist_dir,
            embedding_function=embeddings,
        )

        assert vectorstore.persist_directory == persist_dir


class TestCollectionManagement:
    """Test collection creation and management."""

    def test_get_or_create_collection_new(self, tmp_path: Path) -> None:
        """Test creating a new collection."""
        embeddings = EmbeddingFactory.create_local()
        vectorstore = ChromaVectorStore(
            persist_directory=tmp_path / "vectorstore",
            embedding_function=embeddings,
        )

        collection = vectorstore.get_or_create_collection("test_collection")

        assert collection is not None
        assert "test_collection" in vectorstore._collections

    def test_get_or_create_collection_existing(self, tmp_path: Path) -> None:
        """Test getting an existing collection."""
        embeddings = EmbeddingFactory.create_local()
        vectorstore = ChromaVectorStore(
            persist_directory=tmp_path / "vectorstore",
            embedding_function=embeddings,
        )

        # Create collection
        collection1 = vectorstore.get_or_create_collection("test_collection")

        # Get same collection (should be cached)
        collection2 = vectorstore.get_or_create_collection("test_collection")

        assert collection1 is collection2  # Same object

    def test_multiple_collections(self, tmp_path: Path) -> None:
        """Test managing multiple collections."""
        embeddings = EmbeddingFactory.create_local()
        vectorstore = ChromaVectorStore(
            persist_directory=tmp_path / "vectorstore",
            embedding_function=embeddings,
        )

        coll1 = vectorstore.get_or_create_collection("collection1")
        coll2 = vectorstore.get_or_create_collection("collection2")

        assert coll1 is not coll2
        assert len(vectorstore._collections) == 2
        assert "collection1" in vectorstore._collections
        assert "collection2" in vectorstore._collections


class TestDocumentOperations:
    """Test document addition and retrieval."""

    def test_add_documents_single(self, tmp_path: Path) -> None:
        """Test adding a single document."""
        embeddings = EmbeddingFactory.create_local()
        vectorstore = ChromaVectorStore(
            persist_directory=tmp_path / "vectorstore",
            embedding_function=embeddings,
        )

        docs = [
            Document(
                page_content="Polarized training is 80% low intensity.",
                metadata={"category": "training_methodology"}
            )
        ]

        ids = vectorstore.add_documents("domain_knowledge", docs)

        assert isinstance(ids, list)
        assert len(ids) == 1

    def test_add_documents_multiple(self, tmp_path: Path) -> None:
        """Test adding multiple documents."""
        embeddings = EmbeddingFactory.create_local()
        vectorstore = ChromaVectorStore(
            persist_directory=tmp_path / "vectorstore",
            embedding_function=embeddings,
        )

        docs = [
            Document(
                page_content="Polarized training is 80% low intensity.",
                metadata={"category": "training_methodology"}
            ),
            Document(
                page_content="FTP is functional threshold power.",
                metadata={"category": "testing"}
            ),
            Document(
                page_content="VO2max is maximum oxygen uptake.",
                metadata={"category": "physiology"}
            ),
        ]

        ids = vectorstore.add_documents("domain_knowledge", docs)

        assert len(ids) == 3

    def test_add_documents_empty_list_raises(self, tmp_path: Path) -> None:
        """Test that adding empty list raises ValueError."""
        embeddings = EmbeddingFactory.create_local()
        vectorstore = ChromaVectorStore(
            persist_directory=tmp_path / "vectorstore",
            embedding_function=embeddings,
        )

        with pytest.raises(ValueError) as exc_info:
            vectorstore.add_documents("domain_knowledge", [])

        assert "empty documents list" in str(exc_info.value)


class TestSimilaritySearch:
    """Test similarity search operations."""

    def test_similarity_search_basic(self, tmp_path: Path) -> None:
        """Test basic similarity search."""
        embeddings = EmbeddingFactory.create_local()
        vectorstore = ChromaVectorStore(
            persist_directory=tmp_path / "vectorstore",
            embedding_function=embeddings,
        )

        # Add documents
        docs = [
            Document(
                page_content="Polarized training is 80% low intensity.",
                metadata={"category": "training"}
            ),
            Document(
                page_content="FTP is functional threshold power.",
                metadata={"category": "testing"}
            ),
        ]
        vectorstore.add_documents("domain_knowledge", docs)

        # Search
        results = vectorstore.similarity_search(
            collection_name="domain_knowledge",
            query="polarized training model",
            k=1
        )

        assert len(results) == 1
        assert "polarized" in results[0].page_content.lower()

    def test_similarity_search_top_k(self, tmp_path: Path) -> None:
        """Test top-k retrieval."""
        embeddings = EmbeddingFactory.create_local()
        vectorstore = ChromaVectorStore(
            persist_directory=tmp_path / "vectorstore",
            embedding_function=embeddings,
        )

        # Add documents
        docs = [
            Document(page_content=f"Document number {i}", metadata={"index": i})
            for i in range(10)
        ]
        vectorstore.add_documents("test_collection", docs)

        # Search with k=3
        results = vectorstore.similarity_search(
            collection_name="test_collection",
            query="document",
            k=3
        )

        assert len(results) == 3

    def test_similarity_search_with_metadata_filter(self, tmp_path: Path) -> None:
        """Test similarity search with metadata filtering."""
        embeddings = EmbeddingFactory.create_local()
        vectorstore = ChromaVectorStore(
            persist_directory=tmp_path / "vectorstore",
            embedding_function=embeddings,
        )

        # Add documents with different categories
        docs = [
            Document(
                page_content="Polarized training is effective.",
                metadata={"category": "training"}
            ),
            Document(
                page_content="FTP testing protocols.",
                metadata={"category": "testing"}
            ),
            Document(
                page_content="Sweet spot training intervals.",
                metadata={"category": "training"}
            ),
        ]
        vectorstore.add_documents("domain_knowledge", docs)

        # Search with filter
        results = vectorstore.similarity_search(
            collection_name="domain_knowledge",
            query="training methods",
            k=5,
            filter={"category": "training"}
        )

        # Should only return training documents
        assert len(results) == 2
        assert all(doc.metadata["category"] == "training" for doc in results)

    def test_similarity_search_with_score(self, tmp_path: Path) -> None:
        """Test similarity search with scores."""
        embeddings = EmbeddingFactory.create_local()
        vectorstore = ChromaVectorStore(
            persist_directory=tmp_path / "vectorstore",
            embedding_function=embeddings,
        )

        # Add documents
        docs = [
            Document(
                page_content="Polarized training is 80% low intensity.",
                metadata={"category": "training"}
            ),
            Document(
                page_content="FTP is functional threshold power.",
                metadata={"category": "testing"}
            ),
        ]
        vectorstore.add_documents("domain_knowledge", docs)

        # Search with scores
        results = vectorstore.similarity_search_with_score(
            collection_name="domain_knowledge",
            query="polarized training",
            k=2
        )

        assert len(results) == 2
        # Each result is (Document, score) tuple
        doc1, score1 = results[0]
        assert isinstance(doc1, Document)
        assert isinstance(score1, float)
        assert 0.0 <= score1 <= 1.0

        # First result should be most relevant
        assert "polarized" in doc1.page_content.lower()


class TestPersistence:
    """Test vectorstore persistence."""

    def test_persistence_across_instances(self, tmp_path: Path) -> None:
        """Test that data persists across vectorstore instances."""
        persist_dir = tmp_path / "vectorstore"
        embeddings = EmbeddingFactory.create_local()

        # Create first instance and add documents
        vectorstore1 = ChromaVectorStore(
            persist_directory=persist_dir,
            embedding_function=embeddings,
        )
        docs = [
            Document(
                page_content="Persistent document.",
                metadata={"test": "value"}
            )
        ]
        vectorstore1.add_documents("test_collection", docs)

        # Create second instance (should load persisted data)
        vectorstore2 = ChromaVectorStore(
            persist_directory=persist_dir,
            embedding_function=embeddings,
        )

        # Search should find document from first instance
        results = vectorstore2.similarity_search(
            collection_name="test_collection",
            query="persistent",
            k=1
        )

        assert len(results) == 1
        assert "persistent" in results[0].page_content.lower()


class TestDeleteCollection:
    """Test collection deletion."""

    def test_delete_collection(self, tmp_path: Path) -> None:
        """Test deleting a collection."""
        embeddings = EmbeddingFactory.create_local()
        vectorstore = ChromaVectorStore(
            persist_directory=tmp_path / "vectorstore",
            embedding_function=embeddings,
        )

        # Create and populate collection
        docs = [Document(page_content="Test document")]
        vectorstore.add_documents("test_collection", docs)

        assert "test_collection" in vectorstore._collections

        # Delete collection
        vectorstore.delete_collection("test_collection")

        assert "test_collection" not in vectorstore._collections
```

---

## Acceptance Criteria

- [ ] `vectorstore.py` implemented with `ChromaVectorStore` class
- [ ] Uses LangChain's `Chroma` for all vectorstore operations
- [ ] Supports multi-collection management
- [ ] All tests in `test_vectorstore.py` pass
- [ ] Test coverage â‰¥95% for `vectorstore.py`
- [ ] `mypy --strict` passes with zero errors
- [ ] Persistence verified (data survives restarts)
- [ ] Metadata filtering works correctly

---

## Validation Commands

```bash
# Run tests
pytest tests/rag/test_vectorstore.py -v

# Check coverage
pytest tests/rag/test_vectorstore.py --cov=src/cycling_ai/rag/vectorstore --cov-report=term-missing

# Type check
mypy src/cycling_ai/rag/vectorstore.py --strict

# Integration test (requires Card 2)
python -c "
from pathlib import Path
from cycling_ai.rag.embeddings import EmbeddingFactory
from cycling_ai.rag.vectorstore import ChromaVectorStore
from langchain_core.documents import Document

embeddings = EmbeddingFactory.create_local()
vectorstore = ChromaVectorStore(Path('./test_vs'), embeddings)
docs = [Document(page_content='Test doc', metadata={'test': 1})]
vectorstore.add_documents('test', docs)
results = vectorstore.similarity_search('test', 'test doc', k=1)
print(f'Success: Found {len(results)} documents')
"
```

---

## Time Estimate Breakdown

- Write `vectorstore.py`: 30 min
- Write `test_vectorstore.py`: 60 min
- Run tests: 10 min
- Fix type errors: 15 min
- Documentation: 5 min

**Total: ~2 hours**
