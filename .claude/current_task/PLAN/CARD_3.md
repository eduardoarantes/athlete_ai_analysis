# CARD 3: Plan Service Layer

**Status:** Pending
**Estimated Time:** 3 hours
**Dependencies:** CARD_2
**Assignee:** Implementation Agent

---

## Objective

Create the service layer that wraps the existing `TrainingPlanTool` and converts between API models and tool parameters.

---

## Tasks

### 1. Create `src/cycling_ai/api/services/plan_service.py`

See `PLAN_CODE.md` Section 3.1 for full implementation.

Key responsibilities:
- Convert `TrainingPlanRequest` to tool parameters
- Create temporary athlete profile JSON file
- Execute `TrainingPlanTool`
- Convert tool result to `TrainingPlanResponse`
- Handle errors and validation failures

```python
"""
Training plan generation service.

Wraps TrainingPlanTool to provide a service layer for the API.
"""
from __future__ import annotations

import json
import logging
import tempfile
from pathlib import Path
from typing import Any

from cycling_ai.api.models.plan import (
    AthleteProfileData,
    TrainingPlanRequest,
    TrainingPlanResponse,
)
from cycling_ai.tools.wrappers.training_plan_tool import TrainingPlanTool

logger = logging.getLogger(__name__)


class PlanService:
    """Service for training plan generation."""

    def __init__(self) -> None:
        """Initialize service with tool instance."""
        self.tool = TrainingPlanTool()

    def generate_plan(self, request: TrainingPlanRequest) -> TrainingPlanResponse:
        """
        Generate training plan from request.

        Args:
            request: Training plan request with athlete profile and parameters

        Returns:
            Training plan response with generated plan

        Raises:
            ValueError: If plan generation fails validation
        """
        logger.info(f"Generating training plan: {request.weeks} weeks, target_ftp={request.target_ftp}")

        # Create temporary athlete profile file
        with tempfile.NamedTemporaryFile(
            mode="w", suffix=".json", delete=False
        ) as f:
            profile_data = self._convert_profile_to_json(request.athlete_profile, request.weeks)
            json.dump(profile_data, f, indent=2)
            profile_path = f.name

        try:
            # Calculate target FTP if not provided
            target_ftp = request.target_ftp or (request.athlete_profile.ftp * 1.06)

            # Execute tool
            logger.debug(f"Calling TrainingPlanTool.execute with profile={profile_path}")
            result = self.tool.execute(
                athlete_profile_json=profile_path,
                total_weeks=request.weeks,
                target_ftp=target_ftp,
                weekly_plan=[],  # Will be generated by LLM
                coaching_notes="Generated via API",
                monitoring_guidance="Monitor progress via web dashboard",
            )

            if not result.success:
                error_msg = ", ".join(result.errors) if result.errors else "Unknown error"
                logger.error(f"Plan generation failed: {error_msg}")
                raise ValueError(f"Plan generation failed: {error_msg}")

            logger.info("Plan generation successful")

            # Extract training plan from nested structure
            # TrainingPlanTool returns: {"training_plan": {...}}
            training_plan_data = result.data.get("training_plan", result.data)

            return TrainingPlanResponse(
                training_plan=training_plan_data,
                metadata=result.metadata or {},
            )

        finally:
            # Cleanup temporary file
            Path(profile_path).unlink(missing_ok=True)

    def _convert_profile_to_json(
        self, profile: AthleteProfileData, weeks: int
    ) -> dict[str, Any]:
        """
        Convert AthleteProfileData to athlete_profile.json format.

        Args:
            profile: Athlete profile from request
            weeks: Plan duration in weeks

        Returns:
            Dictionary in athlete_profile.json format
        """
        # Extract training days from availability
        training_days = []
        if profile.training_availability:
            week_days = profile.training_availability.get("week_days", "")
            if isinstance(week_days, str):
                training_days = [day.strip() for day in week_days.split(",")]
            elif isinstance(week_days, list):
                training_days = week_days

        # Build profile dictionary
        profile_dict: dict[str, Any] = {
            "name": "API User",
            "age": profile.age,
            "weight": f"{profile.weight_kg}kg",
            "FTP": f"{profile.ftp}w",
            "training_plan_weeks": weeks,  # Required by TrainingPlanTool
        }

        if profile.max_hr:
            profile_dict["critical_HR"] = profile.max_hr

        if profile.goals:
            profile_dict["goals"] = profile.goals

        if profile.training_availability or training_days:
            profile_dict["training_availability"] = {
                "hours_per_week": (
                    profile.weekly_hours_available
                    or profile.training_availability.get("hours_per_week", 7)
                ),
                "week_days": ", ".join(training_days) if training_days else "Monday, Wednesday, Friday, Saturday, Sunday",
            }

        if profile.experience_level:
            profile_dict["current_training_status"] = profile.experience_level

        return profile_dict
```

### 2. Create `tests/api/services/test_plan_service.py`

```python
"""Tests for plan service."""
from __future__ import annotations

import pytest

from cycling_ai.api.models.plan import AthleteProfileData, TrainingPlanRequest
from cycling_ai.api.services.plan_service import PlanService


@pytest.fixture
def plan_service() -> PlanService:
    """Create plan service instance."""
    return PlanService()


@pytest.fixture
def sample_request() -> TrainingPlanRequest:
    """Create sample training plan request."""
    return TrainingPlanRequest(
        athlete_profile=AthleteProfileData(
            ftp=265,
            weight_kg=70,
            max_hr=186,
            age=35,
            goals=["Improve FTP"],
            training_availability={"hours_per_week": 7, "week_days": "Monday, Wednesday, Friday, Saturday, Sunday"},
        ),
        weeks=12,
        target_ftp=278,
    )


def test_convert_profile_to_json(plan_service: PlanService, sample_request: TrainingPlanRequest) -> None:
    """Test profile conversion to JSON format."""
    profile_dict = plan_service._convert_profile_to_json(
        sample_request.athlete_profile,
        sample_request.weeks
    )

    assert profile_dict["FTP"] == "265w"
    assert profile_dict["weight"] == "70kg"
    assert profile_dict["age"] == 35
    assert profile_dict["training_plan_weeks"] == 12
    assert "training_availability" in profile_dict


@pytest.mark.integration
def test_generate_plan_success(plan_service: PlanService, sample_request: TrainingPlanRequest) -> None:
    """
    Test plan generation end-to-end.

    This is an integration test that requires LLM API keys.
    """
    response = plan_service.generate_plan(sample_request)

    assert response.training_plan is not None
    assert "total_weeks" in response.training_plan
    assert response.training_plan["total_weeks"] == 12


def test_generate_plan_invalid_profile(plan_service: PlanService) -> None:
    """Test plan generation with invalid profile."""
    invalid_request = TrainingPlanRequest(
        athlete_profile=AthleteProfileData(
            ftp=265,
            weight_kg=70,
            age=35,
        ),
        weeks=100,  # Invalid: too many weeks
    )

    # Should be caught by Pydantic validation before reaching service
    # But if it reaches service, should raise ValueError
    with pytest.raises(Exception):  # Could be ValidationError or ValueError
        plan_service.generate_plan(invalid_request)
```

### 3. Update `src/cycling_ai/api/services/__init__.py`

```python
"""
API service layer.

Business logic that wraps existing tools and orchestration.
"""
from .plan_service import PlanService

__all__ = ["PlanService"]
```

---

## Verification Steps

### 1. Run Unit Tests

```bash
pytest tests/api/services/test_plan_service.py::test_convert_profile_to_json -v
```

Expected: PASSED

### 2. Run Integration Test (requires API keys)

```bash
export ANTHROPIC_API_KEY="your-key-here"
pytest tests/api/services/test_plan_service.py::test_generate_plan_success -v -m integration
```

Expected: PASSED (may take 30-60 seconds)

### 3. Type Check

```bash
mypy src/cycling_ai/api/services --strict
```

Expected: No errors

### 4. Manual Test

```python
# In Python REPL
from cycling_ai.api.services import PlanService
from cycling_ai.api.models.plan import TrainingPlanRequest, AthleteProfileData

service = PlanService()

request = TrainingPlanRequest(
    athlete_profile=AthleteProfileData(
        ftp=265,
        weight_kg=70,
        age=35,
        goals=["Improve FTP"],
        training_availability={"hours_per_week": 7, "week_days": "Monday, Wednesday, Friday"}
    ),
    weeks=12,
    target_ftp=278
)

response = service.generate_plan(request)
print(response.training_plan.keys())
# Should print: dict_keys(['athlete_profile', 'plan_metadata', 'coaching_notes', 'monitoring_guidance', 'weekly_plan'])
```

---

## Files Created

- `src/cycling_ai/api/services/plan_service.py`
- `src/cycling_ai/api/services/__init__.py`
- `tests/api/services/__init__.py` (empty)
- `tests/api/services/test_plan_service.py`

---

## Acceptance Criteria

- [x] Service wraps TrainingPlanTool correctly
- [x] Profile conversion works
- [x] Temporary file cleanup works
- [x] Error handling works
- [x] Tests pass (unit and integration)
- [x] Type checking passes
- [x] Logging added for debugging

---

## Next Card

**CARD_4.md** - Create plan router with API endpoints
