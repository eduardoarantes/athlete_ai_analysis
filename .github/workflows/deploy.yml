name: Deploy

on:
  # Push to main: Only build and test Lambda, no automatic deployment
  # NOTE: Web is auto-deployed by AWS Amplify (not this workflow)
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'infrastructure/**'
      - 'requirements-lambda.txt'
      - '.github/workflows/deploy.yml'
  # Manual deployment trigger (required for actual deployment)
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod
      deploy_lambda:
        description: 'Deploy Lambda function'
        required: false
        default: true
        type: boolean
      # NOTE: Web is auto-deployed by AWS Amplify on push to main
      terraform_apply:
        description: 'Apply Terraform changes'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: ap-southeast-2
  PYTHON_VERSION: '3.11'
  TERRAFORM_VERSION: '1.6.0'
  TF_WORKSPACE: ${{ github.event.inputs.environment || 'prod' }}
  # Flag to check if this is a manual deployment trigger
  IS_MANUAL_DEPLOY: ${{ github.event_name == 'workflow_dispatch' }}

jobs:
  # Run tests using cached Docker image from GHCR
  test:
    name: Run Tests (Docker)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull cached test image
        run: |
          # Try to pull the cached image, fall back to building if not available
          docker pull ghcr.io/${{ github.repository }}/python-test:latest || echo "No cached image, will build"

      - name: Run tests
        run: |
          docker run --rm ghcr.io/${{ github.repository }}/python-test:latest \
            pytest tests/ -v --tb=short -q

  # Build Lambda deployment package
  build-lambda:
    name: Build Lambda Package
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event.inputs.deploy_lambda == 'true'
    outputs:
      artifact-name: lambda-package
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build Lambda package
        run: |
          # Create dist directory
          rm -rf dist && mkdir -p dist/package

          # Install dependencies for Lambda (Linux x86_64)
          pip install \
            --platform manylinux2014_x86_64 \
            --target dist/package \
            --implementation cp \
            --python-version 3.11 \
            --only-binary=:all: \
            --upgrade \
            -r requirements-lambda.txt

          # Copy source code
          cp -r src/cycling_ai dist/package/

          # Clean up unnecessary files
          cd dist/package
          find . -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find . -name "*.pyc" -delete 2>/dev/null || true

          # Create zip
          zip -r9 ../lambda.zip . -x "*.pyc" -x "*__pycache__*"

      - name: Upload Lambda artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-package
          path: dist/lambda.zip
          retention-days: 1

  # =============================================================================
  # WEB APPLICATION DEPLOYMENT
  # =============================================================================
  # The Next.js web app is now deployed via AWS Amplify (configured in Terraform).
  # Amplify automatically builds and deploys on push to main branch.
  #
  # Benefits:
  # - Full SSR support (all 26 API routes work)
  # - Automatic builds on push
  # - Preview deployments for PRs
  # - No manual deployment needed
  #
  # See: infrastructure/terraform/amplify.tf
  # =============================================================================

  # Deploy infrastructure with Terraform (manual trigger only)
  terraform:
    name: Terraform (${{ github.event.inputs.environment || 'prod' }})
    runs-on: ubuntu-latest
    needs: [build-lambda]
    # Only run on manual trigger with terraform_apply enabled
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.terraform_apply == 'true'
    environment: ${{ github.event.inputs.environment || 'prod' }}
    defaults:
      run:
        working-directory: infrastructure/terraform
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Lambda artifact
        uses: actions/download-artifact@v4
        with:
          name: lambda-package
          path: dist

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        env:
          # Unset TF_WORKSPACE during init to prevent "workspace doesn't exist" prompt
          TF_WORKSPACE: ""
        run: |
          rm -f .terraform/environment
          terraform init -backend-config="bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}"

      - name: Select Terraform Workspace
        env:
          # Unset during workspace selection to use CLI commands
          TF_WORKSPACE: ""
        run: |
          # Create workspace if it doesn't exist, then select it
          terraform workspace select ${{ github.event.inputs.environment || 'prod' }} 2>/dev/null || \
            terraform workspace new ${{ github.event.inputs.environment || 'prod' }}
          echo "Using workspace: $(terraform workspace show)"

      - name: Terraform Plan
        run: |
          terraform plan \
            -var="supabase_url=${{ secrets.SUPABASE_URL }}" \
            -var="supabase_anon_key=${{ secrets.SUPABASE_ANON_KEY }}" \
            -var="supabase_service_role_key=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -var="supabase_jwt_secret=${{ secrets.SUPABASE_JWT_SECRET }}" \
            -var="anthropic_api_key=${{ secrets.ANTHROPIC_API_KEY }}" \
            -var="github_access_token=${{ secrets.GH_ACCESS_TOKEN }}" \
            -var="strava_client_id=${{ secrets.STRAVA_CLIENT_ID }}" \
            -var="strava_client_secret=${{ secrets.STRAVA_CLIENT_SECRET }}" \
            -var="custom_domain=${{ vars.CUSTOM_DOMAIN }}" \
            -out=tfplan

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        run: terraform apply -auto-approve tfplan

      - name: Show Domain Configuration
        if: github.ref == 'refs/heads/main'
        run: |
          echo "## Domain Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get Route 53 nameservers if custom domain is configured
          NAMESERVERS=$(terraform output -json route53_nameservers 2>/dev/null || echo "[]")
          if [ "$NAMESERVERS" != "[]" ]; then
            echo "### Route 53 Nameservers" >> $GITHUB_STEP_SUMMARY
            echo "Configure these in your domain registrar (Squarespace):" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$NAMESERVERS" | jq -r '.[]' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          # Show Amplify domain status
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Amplify App" >> $GITHUB_STEP_SUMMARY
          terraform output -raw amplify_app_default_domain 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "Not available" >> $GITHUB_STEP_SUMMARY

  # Deploy Lambda function (manual trigger only)
  deploy-lambda:
    name: Deploy Lambda (${{ github.event.inputs.environment || 'prod' }})
    runs-on: ubuntu-latest
    needs: [build-lambda, terraform]
    # Only run on manual trigger - no automatic deployment
    if: always() && needs.build-lambda.result == 'success' && github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_lambda == 'true'
    environment: ${{ github.event.inputs.environment || 'prod' }}
    steps:
      - name: Download Lambda artifact
        uses: actions/download-artifact@v4
        with:
          name: lambda-package
          path: dist

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: aws-account
        run: echo "account_id=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT

      - name: Upload Lambda package to S3
        run: |
          S3_BUCKET="cycling-ai-${{ env.TF_WORKSPACE }}-lambda-code-${{ steps.aws-account.outputs.account_id }}"
          echo "Uploading to S3 bucket: $S3_BUCKET"
          aws s3 cp dist/lambda.zip "s3://${S3_BUCKET}/lambda.zip"

      - name: Deploy to Lambda
        run: |
          FUNCTION_NAME="cycling-ai-${{ env.TF_WORKSPACE }}-api"
          S3_BUCKET="cycling-ai-${{ env.TF_WORKSPACE }}-lambda-code-${{ steps.aws-account.outputs.account_id }}"
          echo "Deploying to Lambda function: $FUNCTION_NAME from S3"
          aws lambda update-function-code \
            --function-name "$FUNCTION_NAME" \
            --s3-bucket "$S3_BUCKET" \
            --s3-key "lambda.zip" \
            --publish

      - name: Wait for Lambda update
        run: |
          FUNCTION_NAME="cycling-ai-${{ env.TF_WORKSPACE }}-api"
          aws lambda wait function-updated \
            --function-name "$FUNCTION_NAME"

  # NOTE: Web deployment is now handled by AWS Amplify automatically.
  # Amplify builds and deploys on every push to main.
  # See: infrastructure/terraform/amplify.tf

  # Summary job
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-lambda]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.TF_WORKSPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lambda | ${{ needs.deploy-lambda.result }} | Manual deploy via this workflow |" >> $GITHUB_STEP_SUMMARY
          echo "| Web | N/A | Auto-deployed via AWS Amplify |" >> $GITHUB_STEP_SUMMARY
