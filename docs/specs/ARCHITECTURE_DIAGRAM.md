# System Architecture Diagram

## Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    INTERNET                                          â”‚
â”‚                                                                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                     â”‚
â”‚     â”‚  User    â”‚                                                                     â”‚
â”‚     â”‚ Browser  â”‚                                                                     â”‚
â”‚     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                                     â”‚
â”‚          â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ HTTPS
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              AWS AMPLIFY                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        Next.js Application                                     â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚      PAGES (SSR)                â”‚  â”‚      API ROUTES (Server)            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                 â”‚  â”‚                                     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  /dashboard                     â”‚  â”‚  /api/activities     â”€â”€â”€â”€â”         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  /coach                         â”‚  â”‚  /api/auth/strava/*      â”‚         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  /reports                       â”‚  â”‚  /api/admin/*            â”‚         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  /training-plans                â”‚  â”‚  /api/coach/*            â”‚ Direct  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  /settings                      â”‚  â”‚  /api/fit-files/*        â”‚ DB      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  /activities                    â”‚  â”‚  /api/strava/*           â”‚ Access  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                 â”‚  â”‚  /api/plan-instances     â”‚         â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                                  â”‚           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                    â”‚                                                â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                                                â”‚
                     â”‚ HTTPS (Lambda Function URL)                    â”‚ HTTPS
                     â”‚ Authorization: Bearer <JWT>                    â”‚ (Supabase Client)
                     â–¼                                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              AWS LAMBDA                             â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚
â”‚  â”‚                    Python FastAPI Backend                      â”‚  â”‚              â”‚
â”‚  â”‚                                                                â”‚  â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚              â”‚
â”‚  â”‚  â”‚              JWT AUTH MIDDLEWARE                          â”‚ â”‚  â”‚              â”‚
â”‚  â”‚  â”‚                                                           â”‚ â”‚  â”‚              â”‚
â”‚  â”‚  â”‚  1. Extract Bearer token from Authorization header        â”‚ â”‚  â”‚              â”‚
â”‚  â”‚  â”‚  2. Validate JWT signature (SUPABASE_JWT_SECRET)          â”‚ â”‚  â”‚              â”‚
â”‚  â”‚  â”‚  3. Check token expiration                                â”‚ â”‚  â”‚              â”‚
â”‚  â”‚  â”‚  4. Extract user_id, email, role from claims              â”‚ â”‚  â”‚              â”‚
â”‚  â”‚  â”‚  5. Reject if invalid â†’ 401 Unauthorized                  â”‚ â”‚  â”‚              â”‚
â”‚  â”‚  â”‚                                                           â”‚ â”‚  â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚              â”‚
â”‚  â”‚                           â”‚                                    â”‚  â”‚              â”‚
â”‚  â”‚                           â–¼ (authenticated request)            â”‚  â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚              â”‚
â”‚  â”‚  â”‚              API ENDPOINTS                                â”‚ â”‚  â”‚              â”‚
â”‚  â”‚  â”‚                                                           â”‚ â”‚  â”‚              â”‚
â”‚  â”‚  â”‚  POST /api/v1/plan/generate     â†’ AI Training Plan Gen    â”‚ â”‚  â”‚              â”‚
â”‚  â”‚  â”‚  GET  /api/v1/plan/status/:id   â†’ Check job status        â”‚ â”‚  â”‚              â”‚
â”‚  â”‚  â”‚  POST /api/v1/analysis          â†’ Performance Analysis    â”‚ â”‚  â”‚              â”‚
â”‚  â”‚  â”‚                                                           â”‚ â”‚  â”‚              â”‚
â”‚  â”‚  â”‚  (Heavy AI orchestration using Claude/Gemini)             â”‚ â”‚  â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚              â”‚
â”‚  â”‚                           â”‚                                    â”‚  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚
â”‚                              â”‚                                       â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚                                       â”‚
                               â”‚ Service Role Key                      â”‚
                               â”‚ (Full DB access)                      â”‚
                               â–¼                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              SUPABASE                                                â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         AUTH SERVICE           â”‚  â”‚              POSTGRESQL                    â”‚ â”‚
â”‚  â”‚                                â”‚  â”‚                                            â”‚ â”‚
â”‚  â”‚  â€¢ Email/Password login        â”‚  â”‚  Tables (with RLS):                        â”‚ â”‚
â”‚  â”‚  â€¢ Google OAuth (planned)      â”‚  â”‚  â”œâ”€â”€ athlete_profiles                      â”‚ â”‚
â”‚  â”‚  â€¢ Session management          â”‚  â”‚  â”œâ”€â”€ strava_connections                    â”‚ â”‚
â”‚  â”‚  â€¢ JWT token issuance          â”‚  â”‚  â”œâ”€â”€ strava_activities                     â”‚ â”‚
â”‚  â”‚  â€¢ Token refresh               â”‚  â”‚  â”œâ”€â”€ training_plans                        â”‚ â”‚
â”‚  â”‚                                â”‚  â”‚  â”œâ”€â”€ plan_instances                        â”‚ â”‚
â”‚  â”‚  Issues JWT with:              â”‚  â”‚  â”œâ”€â”€ reports                               â”‚ â”‚
â”‚  â”‚  - user_id (sub)               â”‚  â”‚  â””â”€â”€ ...                                   â”‚ â”‚
â”‚  â”‚  - email                       â”‚  â”‚                                            â”‚ â”‚
â”‚  â”‚  - role                        â”‚  â”‚  Row Level Security (RLS):                 â”‚ â”‚
â”‚  â”‚  - exp (expiration)            â”‚  â”‚  â€¢ user_id = auth.uid()                    â”‚ â”‚
â”‚  â”‚                                â”‚  â”‚  â€¢ Users can only access own data          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
â”‚  â”‚         STORAGE                â”‚                                                 â”‚
â”‚  â”‚                                â”‚                                                 â”‚
â”‚  â”‚  â€¢ FIT file uploads            â”‚                                                 â”‚
â”‚  â”‚  â€¢ Report attachments          â”‚                                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Request Flow: Training Plan Generation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User   â”‚      â”‚  Amplify    â”‚      â”‚    Lambda    â”‚      â”‚ Supabaseâ”‚      â”‚ Claude   â”‚
â”‚Browser â”‚      â”‚  (Next.js)  â”‚      â”‚  (FastAPI)   â”‚      â”‚   DB    â”‚      â”‚   API    â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚                  â”‚                    â”‚                   â”‚                â”‚
    â”‚ 1. Click "Generate Plan"             â”‚                   â”‚                â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                   â”‚                â”‚
    â”‚                  â”‚                    â”‚                   â”‚                â”‚
    â”‚                  â”‚ 2. Get JWT from Supabase session       â”‚                â”‚
    â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                â”‚
    â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚
    â”‚                  â”‚    JWT token                           â”‚                â”‚
    â”‚                  â”‚                    â”‚                   â”‚                â”‚
    â”‚                  â”‚ 3. POST /api/v1/plan/generate          â”‚                â”‚
    â”‚                  â”‚    Authorization: Bearer <JWT>         â”‚                â”‚
    â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚                  â”‚                    â”‚                   â”‚                â”‚
    â”‚                  â”‚                    â”‚ 4. Validate JWT   â”‚                â”‚
    â”‚                  â”‚                    â”‚    (middleware)   â”‚                â”‚
    â”‚                  â”‚                    â”‚                   â”‚                â”‚
    â”‚                  â”‚                    â”‚ 5. Create job     â”‚                â”‚
    â”‚                  â”‚                    â”‚    (in-memory)    â”‚                â”‚
    â”‚                  â”‚                    â”‚                   â”‚                â”‚
    â”‚                  â”‚ 6. Return job_id   â”‚                   â”‚                â”‚
    â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                â”‚
    â”‚ 7. Show "Generating..."              â”‚                   â”‚                â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                   â”‚                â”‚
    â”‚                  â”‚                    â”‚                   â”‚                â”‚
    â”‚                  â”‚                    â”‚ 8. Fetch athlete profile           â”‚
    â”‚                  â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
    â”‚                  â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
    â”‚                  â”‚                    â”‚                   â”‚                â”‚
    â”‚                  â”‚                    â”‚ 9. Call Claude API â”‚                â”‚
    â”‚                  â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
    â”‚                  â”‚                    â”‚    (Multi-agent orchestration)     â”‚
    â”‚                  â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    â”‚                  â”‚                    â”‚                   â”‚                â”‚
    â”‚                  â”‚                    â”‚ 10. Save plan to DB                â”‚
    â”‚                  â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
    â”‚                  â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
    â”‚                  â”‚                    â”‚                   â”‚                â”‚
    â”‚ 11. Poll GET /status/:job_id         â”‚                   â”‚                â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                   â”‚                â”‚
    â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 12. status: completed                 â”‚                â”‚
    â”‚                  â”‚                    â”‚                   â”‚                â”‚
    â”‚ 13. Show training plan               â”‚                   â”‚                â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                   â”‚                â”‚
    â”‚                  â”‚                    â”‚                   â”‚                â”‚
```

---

## Lambda Security Model

### Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           LAMBDA FUNCTION URL                                        â”‚
â”‚                                                                                      â”‚
â”‚  URL: https://xxxxx.lambda-url.ap-southeast-2.on.aws                                â”‚
â”‚  Authorization Type: NONE (public endpoint)                                          â”‚
â”‚                                                                                      â”‚
â”‚  âš ï¸  The Lambda URL itself is public, but the API handles its own authentication    â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           FASTAPI MIDDLEWARE                                         â”‚
â”‚                                                                                      â”‚
â”‚  Location: src/cycling_ai/api/middleware/auth.py                                    â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  def get_current_user(request: Request) -> User:                               â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â”‚      # 1. Check if path is public (no auth required)                           â”‚ â”‚
â”‚  â”‚      PUBLIC_PATHS = ["/", "/health", "/docs", "/openapi.json", "/api/health"]  â”‚ â”‚
â”‚  â”‚      if path in PUBLIC_PATHS:                                                  â”‚ â”‚
â”‚  â”‚          return None  # Skip auth                                              â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â”‚      # 2. Extract Authorization header                                         â”‚ â”‚
â”‚  â”‚      auth_header = request.headers.get("Authorization")                        â”‚ â”‚
â”‚  â”‚      if not auth_header or not auth_header.startswith("Bearer "):              â”‚ â”‚
â”‚  â”‚          raise HTTPException(401, "Missing or invalid token")                  â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â”‚      # 3. Decode and validate JWT                                              â”‚ â”‚
â”‚  â”‚      token = auth_header.split(" ")[1]                                         â”‚ â”‚
â”‚  â”‚      payload = jwt.decode(                                                     â”‚ â”‚
â”‚  â”‚          token,                                                                â”‚ â”‚
â”‚  â”‚          SUPABASE_JWT_SECRET,  # From environment variable                     â”‚ â”‚
â”‚  â”‚          algorithms=["HS256"],                                                 â”‚ â”‚
â”‚  â”‚          audience="authenticated"                                              â”‚ â”‚
â”‚  â”‚      )                                                                         â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â”‚      # 4. Check expiration (jwt.decode does this automatically)                â”‚ â”‚
â”‚  â”‚      # Raises jwt.ExpiredSignatureError if expired                             â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â”‚      # 5. Extract user information                                             â”‚ â”‚
â”‚  â”‚      return User(                                                              â”‚ â”‚
â”‚  â”‚          id=payload["sub"],           # User ID                                â”‚ â”‚
â”‚  â”‚          email=payload.get("email"),  # User email                             â”‚ â”‚
â”‚  â”‚          role=payload.get("role"),    # authenticated/admin                    â”‚ â”‚
â”‚  â”‚          metadata=payload.get("user_metadata", {})                             â”‚ â”‚
â”‚  â”‚      )                                                                         â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              SECURITY LAYERS                                         â”‚
â”‚                                                                                      â”‚
â”‚  Layer 1: TRANSPORT SECURITY                                                        â”‚
â”‚  â”œâ”€â”€ HTTPS only (TLS 1.2+)                                                          â”‚
â”‚  â”œâ”€â”€ Lambda Function URL provides automatic SSL                                     â”‚
â”‚  â””â”€â”€ No plaintext HTTP allowed                                                      â”‚
â”‚                                                                                      â”‚
â”‚  Layer 2: LAMBDA CONCURRENCY LIMIT (Cost Protection)                                â”‚
â”‚  â”œâ”€â”€ Max concurrent executions: 10 (prod), 5 (staging), 3 (dev)                    â”‚
â”‚  â”œâ”€â”€ Excess requests get throttled (429 error)                                     â”‚
â”‚  â””â”€â”€ Prevents runaway LLM costs from spam attacks                                  â”‚
â”‚                                                                                      â”‚
â”‚  Layer 3: JWT AUTHENTICATION                                                        â”‚
â”‚  â”œâ”€â”€ Tokens signed with SUPABASE_JWT_SECRET (HS256)                                â”‚
â”‚  â”œâ”€â”€ Tokens expire after 1 hour (configurable in Supabase)                         â”‚
â”‚  â”œâ”€â”€ Refresh tokens for session extension                                          â”‚
â”‚  â””â”€â”€ Invalid/expired tokens â†’ 401 Unauthorized                                     â”‚
â”‚                                                                                      â”‚
â”‚  Layer 4: PER-USER RATE LIMITING (Cost Protection)                                  â”‚
â”‚  â”œâ”€â”€ Plan generation: 5 requests per 24 hours                                      â”‚
â”‚  â”œâ”€â”€ Performance analysis: 10 requests per 24 hours                                â”‚
â”‚  â”œâ”€â”€ In-memory sliding window algorithm                                            â”‚
â”‚  â””â”€â”€ Returns 429 with Retry-After header when exceeded                             â”‚
â”‚                                                                                      â”‚
â”‚  Layer 5: AUTHORIZATION (in API handlers)                                           â”‚
â”‚  â”œâ”€â”€ User can only access their own data                                           â”‚
â”‚  â”‚   if request.user_id != current_user.id:                                        â”‚
â”‚  â”‚       raise HTTPException(403, "Access denied")                                 â”‚
â”‚  â”œâ”€â”€ Job ownership verification                                                    â”‚
â”‚  â”‚   if job.user_id != current_user.id:                                            â”‚
â”‚  â”‚       raise HTTPException(403, "Cannot access other users' jobs")               â”‚
â”‚  â””â”€â”€ Admin-only endpoints check role                                               â”‚
â”‚                                                                                      â”‚
â”‚  Layer 6: DATABASE ROW LEVEL SECURITY                                               â”‚
â”‚  â”œâ”€â”€ Even if API is compromised, DB enforces access control                        â”‚
â”‚  â”œâ”€â”€ All queries filtered by user_id = auth.uid()                                  â”‚
â”‚  â””â”€â”€ Service role key bypasses RLS (used by Lambda for admin operations)           â”‚
â”‚                                                                                      â”‚
â”‚  Layer 7: INPUT VALIDATION                                                          â”‚
â”‚  â”œâ”€â”€ Pydantic models validate all inputs                                           â”‚
â”‚  â”œâ”€â”€ SQL injection prevented by ORM/parameterized queries                          â”‚
â”‚  â””â”€â”€ Request size limits enforced                                                   â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Rate Limiting Configuration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              RATE LIMITS                                             â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Endpoint                  â”‚ Limit           â”‚ Window    â”‚ Cost Protection      â”‚â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”‚
â”‚  â”‚  POST /api/v1/plan/generate â”‚ 5 requests     â”‚ 24 hours  â”‚ ~$0.50/request       â”‚â”‚
â”‚  â”‚  POST /api/v1/analysis      â”‚ 10 requests    â”‚ 24 hours  â”‚ ~$0.25/request       â”‚â”‚
â”‚  â”‚  POST /api/coach/suggest    â”‚ 20 requests    â”‚ 1 hour    â”‚ ~$0.05/request       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                      â”‚
â”‚  Implementation: In-memory sliding window (resets on Lambda cold start)             â”‚
â”‚  Response: 429 Too Many Requests with Retry-After header                            â”‚
â”‚                                                                                      â”‚
â”‚  Example response:                                                                   â”‚
â”‚  {                                                                                   â”‚
â”‚    "detail": {                                                                       â”‚
â”‚      "error": "Rate limit exceeded",                                                â”‚
â”‚      "message": "You have reached the limit of 5 plan_generate requests...",       â”‚
â”‚      "limit": 5,                                                                    â”‚
â”‚      "used": 5,                                                                     â”‚
â”‚      "reset_seconds": 43200                                                         â”‚
â”‚    }                                                                                â”‚
â”‚  }                                                                                  â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Why Lambda URL is "NONE" Authorization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     WHY NOT USE AWS_IAM AUTHORIZATION?                               â”‚
â”‚                                                                                      â”‚
â”‚  Option 1: authorization_type = "AWS_IAM"                                           â”‚
â”‚  â”œâ”€â”€ Requires AWS credentials (SigV4 signing) for every request                    â”‚
â”‚  â”œâ”€â”€ Browser cannot sign requests (no AWS SDK in browser)                          â”‚
â”‚  â”œâ”€â”€ Would need API Gateway + Cognito or custom proxy                              â”‚
â”‚  â””â”€â”€ âŒ Not suitable for browser-based web apps                                     â”‚
â”‚                                                                                      â”‚
â”‚  Option 2: authorization_type = "NONE" + JWT middleware (CURRENT)                  â”‚
â”‚  â”œâ”€â”€ Browser sends standard Authorization header                                    â”‚
â”‚  â”œâ”€â”€ FastAPI validates Supabase JWT tokens                                         â”‚
â”‚  â”œâ”€â”€ Same auth mechanism as Next.js API routes                                     â”‚
â”‚  â”œâ”€â”€ Supabase handles user management, token issuance                              â”‚
â”‚  â””â”€â”€ âœ… Works perfectly with browser-based web apps                                 â”‚
â”‚                                                                                      â”‚
â”‚  Security is NOT compromised because:                                               â”‚
â”‚  1. Every request must have valid JWT (except public paths)                         â”‚
â”‚  2. JWT is cryptographically signed by Supabase                                     â”‚
â”‚  3. Lambda verifies signature with shared secret                                    â”‚
â”‚  4. Expired/invalid tokens are rejected                                             â”‚
â”‚  5. User context is extracted from JWT for authorization                            â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Access Patterns

### Next.js API Routes (Amplify) â†’ Supabase

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js API Route: /api/activities                                                â”‚
â”‚                                                                                    â”‚
â”‚  // Uses Supabase client with user's session (anon key + JWT)                     â”‚
â”‚  const supabase = await createClient()  // Server-side client                     â”‚
â”‚  const { data: { user } } = await supabase.auth.getUser()                         â”‚
â”‚                                                                                    â”‚
â”‚  // RLS automatically filters by user_id                                          â”‚
â”‚  const { data: activities } = await supabase                                      â”‚
â”‚    .from('strava_activities')                                                     â”‚
â”‚    .select('*')                                                                   â”‚
â”‚    .eq('user_id', user.id)  // Extra safety, but RLS handles this                â”‚
â”‚                                                                                    â”‚
â”‚  Access Level: USER'S OWN DATA ONLY (via RLS)                                     â”‚
â”‚  Key Used: SUPABASE_ANON_KEY (public, safe for browser)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Lambda â†’ Supabase

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Lambda: Training Plan Generation                                                  â”‚
â”‚                                                                                    â”‚
â”‚  // Uses service role key (bypasses RLS)                                          â”‚
â”‚  supabase = create_client(                                                        â”‚
â”‚      SUPABASE_URL,                                                                â”‚
â”‚      SUPABASE_SERVICE_ROLE_KEY  # Full database access                            â”‚
â”‚  )                                                                                â”‚
â”‚                                                                                    â”‚
â”‚  // Can access any user's data (needed for background jobs)                       â”‚
â”‚  # But API handlers verify user owns the resource                                 â”‚
â”‚  if request.user_id != current_user.id:                                           â”‚
â”‚      raise HTTPException(403)                                                     â”‚
â”‚                                                                                    â”‚
â”‚  // Save plan for authenticated user                                              â”‚
â”‚  supabase.table('training_plans').insert({                                        â”‚
â”‚      'user_id': current_user.id,  # From validated JWT                            â”‚
â”‚      'plan_data': generated_plan                                                  â”‚
â”‚  })                                                                               â”‚
â”‚                                                                                    â”‚
â”‚  Access Level: FULL DATABASE (service role)                                       â”‚
â”‚  Key Used: SUPABASE_SERVICE_ROLE_KEY (secret, never exposed to browser)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Environment Variables by Component

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AMPLIFY (Next.js)                                                                  â”‚
â”‚  â”œâ”€â”€ NEXT_PUBLIC_SUPABASE_URL      â†’ Supabase project URL (public)                 â”‚
â”‚  â”œâ”€â”€ NEXT_PUBLIC_SUPABASE_ANON_KEY â†’ Supabase anon key (public, safe for browser)  â”‚
â”‚  â”œâ”€â”€ NEXT_PUBLIC_API_URL           â†’ Lambda Function URL                           â”‚
â”‚  â”œâ”€â”€ NEXT_PUBLIC_STRAVA_CLIENT_ID  â†’ Strava OAuth app ID                           â”‚
â”‚  â””â”€â”€ NEXT_PUBLIC_ENV               â†’ Environment (dev/staging/prod)                â”‚
â”‚                                                                                      â”‚
â”‚  Note: NEXT_PUBLIC_* variables are exposed to browser (intentionally)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LAMBDA (Python FastAPI)                                                            â”‚
â”‚  â”œâ”€â”€ SUPABASE_URL                  â†’ Supabase project URL                          â”‚
â”‚  â”œâ”€â”€ SUPABASE_SERVICE_ROLE_KEY     â†’ ğŸ”’ Service role (NEVER expose to browser)     â”‚
â”‚  â”œâ”€â”€ SUPABASE_JWT_SECRET           â†’ ğŸ”’ JWT signing secret (for validation)        â”‚
â”‚  â”œâ”€â”€ ANTHROPIC_API_KEY             â†’ ğŸ”’ Claude API key                             â”‚
â”‚  â”œâ”€â”€ GOOGLE_API_KEY                â†’ ğŸ”’ Gemini API key (optional)                  â”‚
â”‚  â”œâ”€â”€ OPENAI_API_KEY                â†’ ğŸ”’ OpenAI API key (optional)                  â”‚
â”‚  â””â”€â”€ ENVIRONMENT                   â†’ Environment (dev/staging/prod)                â”‚
â”‚                                                                                      â”‚
â”‚  Note: All sensitive, stored in AWS SSM Parameter Store / Secrets Manager           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary

| Component | Hosts | Talks To | Auth Method |
|-----------|-------|----------|-------------|
| **Browser** | User's device | Amplify | Supabase session cookie |
| **Amplify (Next.js)** | AWS Amplify | Supabase, Lambda | Supabase anon key + JWT |
| **Next.js API Routes** | AWS Amplify | Supabase | Supabase anon key (RLS enforced) |
| **Lambda (FastAPI)** | AWS Lambda | Supabase, Claude/Gemini | Service role key (full access) |
| **Supabase** | Supabase Cloud | - | JWT validation, RLS policies |

**Key Security Points:**
1. Lambda URL is public, but JWT authentication is enforced in middleware
2. Supabase JWT tokens are cryptographically signed and validated
3. Row Level Security (RLS) provides defense-in-depth at database level
4. Service role key (Lambda) is never exposed to browser
5. All traffic is HTTPS encrypted
