"""
Unit tests for add_week_tool.py validation enhancements.

Tests:
- 6-day week recovery detection
- Multi-scenario validation
- Auto-fix functionality
- Endurance workout identification
"""
import json
import tempfile
from pathlib import Path
from typing import Any

import pytest

from cycling_ai.tools.wrappers.add_week_tool import (
    _detect_optional_recovery_workout,
    _calculate_week_metrics,
    _validate_time_and_tss,
    _is_endurance_workout,
    _find_weekend_endurance_rides,
    _attempt_auto_fix,
)


Test fixtures
@pytest.fixture
def temp_dir():
    """Create temporary directory for test files."""
    with tempfile.TemporaryDirectory() as tmpdir:
        yield Path(tmpdir)


@pytest.fixture
def sample_endurance_workout() -> dict[str, Any]:
    """Sample endurance workout for testing."""
    return {
        "weekday": "Saturday",
        "description": "Long endurance ride - Zone 2",
        "segments": [
            {"type": "warmup", "duration_min": 10, "power_low_pct": 50, "power_high_pct": 60, "description": "Warmup"},
            {"type": "steady", "duration_min": 120, "power_low_pct": 65, "power_high_pct": 75, "description": "Endurance"},
            {"type": "cooldown", "duration_min": 10, "power_low_pct": 50, "power_high_pct": 60, "description": "Cooldown"},
        ]
    }


@pytest.fixture
def sample_interval_workout() -> dict[str, Any]:
    """Sample high-power interval workout."""
    return {
        "weekday": "Tuesday",
        "description": "VO2max intervals",
        "segments": [
            {"type": "warmup", "duration_min": 15, "power_low_pct": 50, "power_high_pct": 60, "description": "Warmup"},
            {"type": "intervals", "duration_min": 30, "power_low_pct": 105, "power_high_pct": 120, "description": "5x4min @ 120%"},
            {"type": "cooldown", "duration_min": 15, "power_low_pct": 50, "power_high_pct": 60, "description": "Cooldown"},
        ]
    }


@pytest.fixture
def sample_recovery_workout() -> dict[str, Any]:
    """Sample recovery workout."""
    return {
        "weekday": "Wednesday",
        "description": "Easy recovery spin",
        "segments": [
            {"type": "recovery", "duration_min": 45, "power_low_pct": 45, "power_high_pct": 55, "description": "Easy spin"},
        ]
    }


# ============================================================================
Test Class 1: TestDetectOptionalRecoveryWorkout
# ============================================================================
class TestDetectOptionalRecoveryWorkout:
    """Tests for _detect_optional_recovery_workout()"""

    def test_six_day_with_one_recovery(self):
        """6 days, 1 recovery → Returns (index, weekday)"""
        training_days_objects = [
            {"weekday": "Monday", "workout_type": "endurance"},
            {"weekday": "Tuesday", "workout_type": "intervals"},
            {"weekday": "Wednesday", "workout_type": "recovery"},
            {"weekday": "Thursday", "workout_type": "endurance"},
            {"weekday": "Friday", "workout_type": "intervals"},
            {"weekday": "Saturday", "workout_type": "endurance"},
            {"weekday": "Sunday", "workout_type": "rest"},
        ]

        workouts = [
            {"weekday": "Monday", "description": "Endurance"},
            {"weekday": "Tuesday", "description": "Intervals"},
            {"weekday": "Wednesday", "description": "Recovery"},
            {"weekday": "Thursday", "description": "Endurance"},
            {"weekday": "Friday", "description": "Intervals"},
            {"weekday": "Saturday", "description": "Endurance"},
        ]

        idx, weekday = _detect_optional_recovery_workout(workouts, training_days_objects, 1)
        assert idx == 2
        assert weekday == "Wednesday"    def test_six_day_with_multiple_recoveries(self):
        """6 days, 2+ recoveries → Returns first recovery"""
        from cycling_ai.tools.wrappers.add_week_tool import _detect_optional_recovery_workout

        training_days_objects = [
            {"weekday": "Monday", "workout_type": "recovery"},
            {"weekday": "Tuesday", "workout_type": "intervals"},
            {"weekday": "Wednesday", "workout_type": "recovery"},
            {"weekday": "Thursday", "workout_type": "endurance"},
            {"weekday": "Friday", "workout_type": "intervals"},
            {"weekday": "Saturday", "workout_type": "endurance"},
            {"weekday": "Sunday", "workout_type": "rest"},
        ]

        workouts = [
            {"weekday": "Monday", "description": "Recovery 1"},
            {"weekday": "Tuesday", "description": "Intervals"},
            {"weekday": "Wednesday", "description": "Recovery 2"},
            {"weekday": "Thursday", "description": "Endurance"},
            {"weekday": "Friday", "description": "Intervals"},
            {"weekday": "Saturday", "description": "Endurance"},
        ]

        idx, weekday = _detect_optional_recovery_workout(workouts, training_days_objects, 1)
        Should return FIRST recovery
        assert idx == 0
        assert weekday == "Monday"    def test_six_day_no_recovery(self):
        """6 days, 0 recoveries → Returns (None, None)"""
        from cycling_ai.tools.wrappers.add_week_tool import _detect_optional_recovery_workout

        training_days_objects = [
            {"weekday": "Monday", "workout_type": "endurance"},
            {"weekday": "Tuesday", "workout_type": "intervals"},
            {"weekday": "Wednesday", "workout_type": "endurance"},
            {"weekday": "Thursday", "workout_type": "intervals"},
            {"weekday": "Friday", "workout_type": "endurance"},
            {"weekday": "Saturday", "workout_type": "endurance"},
            {"weekday": "Sunday", "workout_type": "rest"},
        ]

        workouts = [
            {"weekday": "Monday", "description": "Endurance"},
            {"weekday": "Tuesday", "description": "Intervals"},
            {"weekday": "Wednesday", "description": "Endurance"},
            {"weekday": "Thursday", "description": "Intervals"},
            {"weekday": "Friday", "description": "Endurance"},
            {"weekday": "Saturday", "description": "Endurance"},
        ]

        idx, weekday = _detect_optional_recovery_workout(workouts, training_days_objects, 1)
        assert idx is None
        assert weekday is None    def test_five_day_with_recovery(self):
        """5 days, 1 recovery → Returns (None, None)"""
        from cycling_ai.tools.wrappers.add_week_tool import _detect_optional_recovery_workout

        training_days_objects = [
            {"weekday": "Monday", "workout_type": "endurance"},
            {"weekday": "Tuesday", "workout_type": "intervals"},
            {"weekday": "Wednesday", "workout_type": "recovery"},
            {"weekday": "Thursday", "workout_type": "rest"},
            {"weekday": "Friday", "workout_type": "intervals"},
            {"weekday": "Saturday", "workout_type": "endurance"},
            {"weekday": "Sunday", "workout_type": "rest"},
        ]

        workouts = [
            {"weekday": "Monday", "description": "Endurance"},
            {"weekday": "Tuesday", "description": "Intervals"},
            {"weekday": "Wednesday", "description": "Recovery"},
            {"weekday": "Friday", "description": "Intervals"},
            {"weekday": "Saturday", "description": "Endurance"},
        ]

        idx, weekday = _detect_optional_recovery_workout(workouts, training_days_objects, 1)
        assert idx is None
        assert weekday is None    def test_seven_day_with_recovery(self):
        """7 days → Returns (None, None)"""
        from cycling_ai.tools.wrappers.add_week_tool import _detect_optional_recovery_workout

        training_days_objects = [
            {"weekday": "Monday", "workout_type": "endurance"},
            {"weekday": "Tuesday", "workout_type": "intervals"},
            {"weekday": "Wednesday", "workout_type": "recovery"},
            {"weekday": "Thursday", "workout_type": "endurance"},
            {"weekday": "Friday", "workout_type": "intervals"},
            {"weekday": "Saturday", "workout_type": "endurance"},
            {"weekday": "Sunday", "workout_type": "endurance"},
        ]

        workouts = [
            {"weekday": "Monday", "description": "Endurance"},
            {"weekday": "Tuesday", "description": "Intervals"},
            {"weekday": "Wednesday", "description": "Recovery"},
            {"weekday": "Thursday", "description": "Endurance"},
            {"weekday": "Friday", "description": "Intervals"},
            {"weekday": "Saturday", "description": "Endurance"},
            {"weekday": "Sunday", "description": "Endurance"},
        ]

        idx, weekday = _detect_optional_recovery_workout(workouts, training_days_objects, 1)
        assert idx is None
        assert weekday is None


# ============================================================================
Test Class 2: TestCalculateWeekMetrics
# ============================================================================
class TestCalculateWeekMetrics:
    """Tests for _calculate_week_metrics()"""    def test_calculate_all_workouts(self):
        """Calculate with all workouts"""
        from cycling_ai.tools.wrappers.add_week_tool import _calculate_week_metrics

        workouts = [
            {"weekday": "Monday", "segments": [{"duration_min": 60, "power_low_pct": 70, "power_high_pct": 75}]},
            {"weekday": "Wednesday", "segments": [{"duration_min": 90, "power_low_pct": 65, "power_high_pct": 70}]},
            {"weekday": "Friday", "segments": [{"duration_min": 45, "power_low_pct": 90, "power_high_pct": 105}]},
        ]
        current_ftp = 250

        total_hours, actual_tss = _calculate_week_metrics(workouts, current_ftp)

        # 60 + 90 + 45 = 195 minutes = 3.25 hours
        assert total_hours == 3.25
        assert actual_tss > 0  # TSS should be calculated    def test_calculate_exclude_workout(self):
        """Calculate excluding specific workout"""
        from cycling_ai.tools.wrappers.add_week_tool import _calculate_week_metrics

        workouts = [
            {"weekday": "Monday", "segments": [{"duration_min": 60, "power_low_pct": 70, "power_high_pct": 75}]},
            {"weekday": "Wednesday", "segments": [{"duration_min": 90, "power_low_pct": 65, "power_high_pct": 70}]},
            {"weekday": "Friday", "segments": [{"duration_min": 45, "power_low_pct": 90, "power_high_pct": 105}]},
        ]
        current_ftp = 250

        total_hours, actual_tss = _calculate_week_metrics(workouts, current_ftp, exclude_workout_index=1)

        # 60 + 45 = 105 minutes = 1.75 hours (excluded Wednesday)
        assert total_hours == 1.75    def test_empty_workouts(self):
        """Empty list → (0.0, 0.0)"""
        from cycling_ai.tools.wrappers.add_week_tool import _calculate_week_metrics

        total_hours, actual_tss = _calculate_week_metrics([], 250)
        assert total_hours == 0.0
        assert actual_tss == 0.0


# ============================================================================
Test Class 3: TestValidateTimeAndTSS
# ============================================================================
class TestValidateTimeAndTSS:
    """Tests for _validate_time_and_tss()"""    def test_within_tolerance(self):
        """Within tolerance → ([], [])"""
        from cycling_ai.tools.wrappers.add_week_tool import _validate_time_and_tss

        warnings, errors = _validate_time_and_tss(
            total_hours=10.0,
            actual_tss=500,
            target_hours=10.0,
            target_tss=500,
            week_number=1,
            is_recovery_week=False
        )
        assert warnings == []
        assert errors == []    def test_warning_threshold(self):
        """Warning threshold exceeded → ([warning], [])"""
        from cycling_ai.tools.wrappers.add_week_tool import _validate_time_and_tss

        # 12% difference (normal: 10% warn, 20% error)
        warnings, errors = _validate_time_and_tss(
            total_hours=11.2,  # 12% over 10.0
            actual_tss=500,
            target_hours=10.0,
            target_tss=500,
            week_number=1,
            is_recovery_week=False
        )
        assert len(warnings) == 1
        assert "time budget warning" in warnings[0].lower()
        assert errors == []    def test_error_threshold(self):
        """Error threshold exceeded → ([], [error])"""
        from cycling_ai.tools.wrappers.add_week_tool import _validate_time_and_tss

        # 25% difference (normal: 10% warn, 20% error)
        warnings, errors = _validate_time_and_tss(
            total_hours=12.5,  # 25% over 10.0
            actual_tss=500,
            target_hours=10.0,
            target_tss=500,
            week_number=1,
            is_recovery_week=False
        )
        assert warnings == []
        assert len(errors) == 1
        assert "time budget violation" in errors[0].lower()    def test_recovery_week_stricter(self):
        """Recovery week uses stricter tolerances"""
        from cycling_ai.tools.wrappers.add_week_tool import _validate_time_and_tss

        # 16% difference
        # Recovery: 8% warn, 15% error → should be ERROR
        # Normal: 10% warn, 20% error → should be WARNING

        warnings_recovery, errors_recovery = _validate_time_and_tss(
            total_hours=11.6,  # 16% over 10.0
            actual_tss=500,
            target_hours=10.0,
            target_tss=500,
            week_number=1,
            is_recovery_week=True
        )
        assert len(errors_recovery) == 1  # Error for recovery

        warnings_normal, errors_normal = _validate_time_and_tss(
            total_hours=11.6,  # 16% over 10.0
            actual_tss=500,
            target_hours=10.0,
            target_tss=500,
            week_number=1,
            is_recovery_week=False
        )
        assert len(warnings_normal) == 1  # Warning for normal
        assert errors_normal == []    def test_no_targets(self):
        """No targets → ([], [])"""
        from cycling_ai.tools.wrappers.add_week_tool import _validate_time_and_tss

        warnings, errors = _validate_time_and_tss(
            total_hours=10.0,
            actual_tss=500,
            target_hours=None,
            target_tss=None,
            week_number=1,
            is_recovery_week=False
        )
        assert warnings == []
        assert errors == []


# ============================================================================
Test Class 4: TestIsEnduranceWorkout
# ============================================================================
class TestIsEnduranceWorkout:
    """Tests for _is_endurance_workout()"""    def test_keyword_in_description(self, sample_endurance_workout):
        """Keyword in description → True"""
        from cycling_ai.tools.wrappers.add_week_tool import _is_endurance_workout

        assert _is_endurance_workout(sample_endurance_workout) is True    def test_segment_type_ratio(self):
        """80% endurance segments → True"""
        from cycling_ai.tools.wrappers.add_week_tool import _is_endurance_workout

        workout = {
            "weekday": "Saturday",
            "description": "Long ride",
            "segments": [
                {"type": "endurance", "duration_min": 60, "power_low_pct": 65, "power_high_pct": 75, "description": "Z2"},
                {"type": "endurance", "duration_min": 60, "power_low_pct": 65, "power_high_pct": 75, "description": "Z2"},
                {"type": "steady", "duration_min": 60, "power_low_pct": 70, "power_high_pct": 78, "description": "Z2"},
                {"type": "intervals", "duration_min": 20, "power_low_pct": 90, "power_high_pct": 105, "description": "Sprints"},
            ]
        }

        # 3/4 = 75% endurance type, should be >= 50%
        assert _is_endurance_workout(workout) is True    def test_duration_ratio(self):
        """75% duration in endurance zones → True"""
        from cycling_ai.tools.wrappers.add_week_tool import _is_endurance_workout

        workout = {
            "weekday": "Saturday",
            "description": "Long ride",
            "segments": [
                {"type": "steady", "duration_min": 150, "power_low_pct": 65, "power_high_pct": 75, "description": "Z2"},
                {"type": "intervals", "duration_min": 50, "power_low_pct": 105, "power_high_pct": 120, "description": "Hard"},
            ]
        }

        # 150/200 = 75% of duration at < 80% power
        assert _is_endurance_workout(workout) is True    def test_high_power_intervals(self, sample_interval_workout):
        """High-power intervals → False"""
        from cycling_ai.tools.wrappers.add_week_tool import _is_endurance_workout

        assert _is_endurance_workout(sample_interval_workout) is False    def test_empty_segments(self):
        """Empty segments → False"""
        from cycling_ai.tools.wrappers.add_week_tool import _is_endurance_workout

        workout = {
            "weekday": "Monday",
            "description": "Test",
            "segments": []
        }

        assert _is_endurance_workout(workout) is False


# ============================================================================
Test Class 5: TestFindWeekendEnduranceRides
# ============================================================================
class TestFindWeekendEnduranceRides:
    """Tests for _find_weekend_endurance_rides()"""    def test_saturday_endurance(self, sample_endurance_workout):
        """Saturday endurance → Found"""
        from cycling_ai.tools.wrappers.add_week_tool import _find_weekend_endurance_rides

        workouts = [
            {"weekday": "Monday", "description": "Intervals", "segments": [{"type": "intervals", "duration_min": 60, "power_low_pct": 100, "power_high_pct": 120, "description": "Hard"}]},
            sample_endurance_workout,  # Saturday
        ]

        weekend_rides = _find_weekend_endurance_rides(workouts)
        assert len(weekend_rides) == 1
        assert weekend_rides[0]["weekday"] == "Saturday"
        assert weekend_rides[0]["workout_index"] == 1    def test_sunday_endurance(self):
        """Sunday endurance → Found"""
        from cycling_ai.tools.wrappers.add_week_tool import _find_weekend_endurance_rides

        workout_sunday = {
            "weekday": "Sunday",
            "description": "Easy endurance ride",
            "segments": [
                {"type": "steady", "duration_min": 90, "power_low_pct": 65, "power_high_pct": 75, "description": "Z2"},
            ]
        }

        workouts = [workout_sunday]

        weekend_rides = _find_weekend_endurance_rides(workouts)
        assert len(weekend_rides) == 1
        assert weekend_rides[0]["weekday"] == "Sunday"    def test_saturday_intervals(self, sample_interval_workout):
        """Saturday intervals → Not found"""
        from cycling_ai.tools.wrappers.add_week_tool import _find_weekend_endurance_rides

        saturday_intervals = dict(sample_interval_workout)
        saturday_intervals["weekday"] = "Saturday"

        workouts = [saturday_intervals]

        weekend_rides = _find_weekend_endurance_rides(workouts)
        assert len(weekend_rides) == 0    def test_monday_endurance(self):
        """Monday endurance → Not found"""
        from cycling_ai.tools.wrappers.add_week_tool import _find_weekend_endurance_rides

        workout_monday = {
            "weekday": "Monday",
            "description": "Easy endurance ride",
            "segments": [
                {"type": "steady", "duration_min": 90, "power_low_pct": 65, "power_high_pct": 75, "description": "Z2"},
            ]
        }

        workouts = [workout_monday]

        weekend_rides = _find_weekend_endurance_rides(workouts)
        assert len(weekend_rides) == 0    def test_multiple_weekend_endurance(self):
        """Multiple weekend rides → Sorted by duration"""
        from cycling_ai.tools.wrappers.add_week_tool import _find_weekend_endurance_rides

        saturday_short = {
            "weekday": "Saturday",
            "description": "Short Z2",
            "segments": [{"type": "steady", "duration_min": 60, "power_low_pct": 65, "power_high_pct": 75, "description": "Z2"}]
        }

        sunday_long = {
            "weekday": "Sunday",
            "description": "Long Z2",
            "segments": [{"type": "steady", "duration_min": 120, "power_low_pct": 65, "power_high_pct": 75, "description": "Z2"}]
        }

        workouts = [saturday_short, sunday_long]

        weekend_rides = _find_weekend_endurance_rides(workouts)
        assert len(weekend_rides) == 2
        # Should be sorted longest first
        assert weekend_rides[0]["weekday"] == "Sunday"
        assert weekend_rides[0]["duration_min"] == 120
        assert weekend_rides[1]["weekday"] == "Saturday"
        assert weekend_rides[1]["duration_min"] == 60


# ============================================================================
Test Class 6: TestAttemptAutoFix
# ============================================================================
class TestAttemptAutoFix:
    """Tests for _attempt_auto_fix()"""    def test_no_target(self):
        """No target → (None, reason)"""
        from cycling_ai.tools.wrappers.add_week_tool import _attempt_auto_fix

        workouts = [{"weekday": "Monday", "segments": [{"duration_min": 60}]}]

        modified, log = _attempt_auto_fix(workouts, None, 250, 1)
        assert modified is None
        assert "no target" in log.lower()    def test_already_under_budget(self):
        """Already under budget → (None, reason)"""
        from cycling_ai.tools.wrappers.add_week_tool import _attempt_auto_fix

        workouts = [{"weekday": "Monday", "segments": [{"duration_min": 60, "power_low_pct": 70, "power_high_pct": 75}]}]

        modified, log = _attempt_auto_fix(workouts, 2.0, 250, 1)  # 60 min = 1.0h < 2.0h
        assert modified is None
        assert "already within budget" in log.lower()    def test_no_weekend_endurance(self):
        """No weekend endurance → (None, reason)"""
        from cycling_ai.tools.wrappers.add_week_tool import _attempt_auto_fix

        Only weekday workouts
        workouts = [
            {"weekday": "Monday", "segments": [{"type": "intervals", "duration_min": 60, "power_low_pct": 100, "power_high_pct": 120, "description": "Hard"}]},
            {"weekday": "Tuesday", "segments": [{"type": "intervals", "duration_min": 60, "power_low_pct": 100, "power_high_pct": 120, "description": "Hard"}]},
        ]

        modified, log = _attempt_auto_fix(workouts, 0.5, 250, 1)  # 2h > 0.5h target
        assert modified is None
        assert "no weekend endurance" in log.lower()    def test_warmup_cooldown_removal_fixes(self):
        """Removing warmup/cooldown brings under budget → Success"""
        from cycling_ai.tools.wrappers.add_week_tool import _attempt_auto_fix

        workouts = [
            {
                "weekday": "Saturday",
                "description": "Endurance ride",
                "segments": [
                    {"type": "warmup", "duration_min": 10, "power_low_pct": 50, "power_high_pct": 60, "description": "Warmup"},
                    {"type": "steady", "duration_min": 150, "power_low_pct": 65, "power_high_pct": 75, "description": "Z2"},
                    {"type": "cooldown", "duration_min": 10, "power_low_pct": 50, "power_high_pct": 60, "description": "Cooldown"},
                ]
            }
        ]

        # Total: 170 min = 2.833h, target: 2.5h
        # Removing warmup/cooldown: 150 min = 2.5h → should fix it
        modified, log = _attempt_auto_fix(workouts, 2.5, 250, 1)

        assert modified is not None
        assert len(modified[0]["segments"]) == 1  # Only main block remains
        assert "warmup/cooldown" in log.lower()    def test_main_block_reduction_needed(self):
        """Main block reduction needed → Success"""
        from cycling_ai.tools.wrappers.add_week_tool import _attempt_auto_fix

        workouts = [
            {
                "weekday": "Saturday",
                "description": "Endurance ride",
                "segments": [
                    {"type": "steady", "duration_min": 180, "power_low_pct": 65, "power_high_pct": 75, "description": "Z2"},
                ]
            }
        ]

        # Total: 180 min = 3.0h, target: 2.0h
        # Need to reduce main block by 60 min (4 iterations of 15 min)
        modified, log = _attempt_auto_fix(workouts, 2.0, 250, 1)

        assert modified is not None
        total_duration = sum(seg["duration_min"] for seg in modified[0]["segments"])
        assert total_duration == 120  # 180 - 60 = 120 min = 2.0h    def test_hits_minimum_duration(self):
        """Hits 60 min minimum → (None, reason)"""
        from cycling_ai.tools.wrappers.add_week_tool import _attempt_auto_fix

        workouts = [
            {
                "weekday": "Saturday",
                "description": "Endurance ride",
                "segments": [
                    {"type": "steady", "duration_min": 75, "power_low_pct": 65, "power_high_pct": 75, "description": "Z2"},
                ]
            }
        ]

        # Total: 75 min = 1.25h, target: 0.5h
        # Would need to reduce to 30 min, but minimum is 60 min
        modified, log = _attempt_auto_fix(workouts, 0.5, 250, 1)

        assert modified is None
        assert "minimum" in log.lower()    def test_non_destructive(self):
        """Original workouts not modified"""
        from cycling_ai.tools.wrappers.add_week_tool import _attempt_auto_fix

        original_workouts = [
            {
                "weekday": "Saturday",
                "description": "Endurance ride",
                "segments": [
                    {"type": "warmup", "duration_min": 10, "power_low_pct": 50, "power_high_pct": 60, "description": "Warmup"},
                    {"type": "steady", "duration_min": 150, "power_low_pct": 65, "power_high_pct": 75, "description": "Z2"},
                    {"type": "cooldown", "duration_min": 10, "power_low_pct": 50, "power_high_pct": 60, "description": "Cooldown"},
                ]
            }
        ]

        # Make a copy to compare
        import copy
        workouts_before = copy.deepcopy(original_workouts)

        modified, log = _attempt_auto_fix(original_workouts, 2.5, 250, 1)

        # Original should be unchanged
        assert original_workouts == workouts_before
        # Modified should be different
        assert modified != original_workouts


# ============================================================================
Test Class 7: TestAddWeekDetailsToolIntegration
# ============================================================================
class TestAddWeekDetailsToolIntegration:
    """Integration tests for complete workflow"""    def test_six_day_passes_with_all_workouts(self, temp_dir):
        """6 days, 1 recovery, passes with all → No optional marking"""
        pass    def test_six_day_passes_without_recovery(self, temp_dir):
        """6 days, 1 recovery, passes without → Recovery marked optional"""
        pass    def test_six_day_fails_both_scenarios_auto_fix(self, temp_dir):
        """6 days, fails both → Auto-fix applied"""
        pass    def test_auto_fix_disabled(self, temp_dir):
        """auto_fix=False → No auto-fix, error raised"""
        pass    def test_auto_fix_successful(self, temp_dir):
        """Auto-fix reduces endurance ride → Success"""
        pass    def test_auto_fix_insufficient(self, temp_dir):
        """Auto-fix can't reach target → Error raised"""
        pass
